<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" href="assets/favicon.svg" type="svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Виртуальные валентинки</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&family=Yeseva+One&display=swap" rel="stylesheet">
</head>
<body>
    <div class="bg">
        <div class="orb orb-a"></div>
        <div class="orb orb-b"></div>
        <div class="orb orb-c"></div>
    </div>

    <header class="header">
        <a class="logo" href="./"><img src="assets/logo.png" alt="Логотип"></a>
        <div class="brand">
            <div class="eyebrow">14 февраля</div>
            <h1>Виртуальные валентинки</h1>
        </div>
        <a class="btn ghost" href="https://hotsamsawithoneui.t.me">Telegram</a>
    </header>

    <main class="container">
        <section class="card" id="builder">
            <div class="card-head">
                <h2>Создай свою валентинку</h2>
                <p>Заполни поля, получи ссылку и отправь её тому, кто тебе важен.</p>
            </div>
            <form class="form" id="valentine-form">
                <label>
                    Имя получателя
                    <input type="text" id="toName" placeholder="Например: Алина" maxlength="40" required>
                </label>
                <label>
                    Пожелания
                    <textarea id="wishes" placeholder="Напиши пару тёплых слов" maxlength="240" required></textarea>
                </label>
                <label>
                    Твоё имя (необязательно)
                    <input type="text" id="fromName" placeholder="От кого валентинка" maxlength="40">
                </label>
                <div class="image-block">
                    <div class="image-title">Картинка для валентинки (необязательно)</div>
                    <label>
                        Вставь прямую ссылку на картинку
                        <input type="url" id="imageUrl" placeholder="https://..." maxlength="500">
                    </label>
                    <div class="image-preview" id="imagePreview" hidden>
                        <img id="previewImg" alt="Предпросмотр">
                    </div>
                </div>
                <label class="checkbox">
                    <input type="checkbox" id="shortenToggle" checked>
                    Сократить ссылку через clck.ru
                </label>
                <button class="btn" type="submit">Сгенерировать ссылку</button>
            </form>

            <div class="result" id="linkBox" hidden>
                <div class="result-row">
                    <input id="shareLink" type="text" readonly>
                    <button class="btn small" id="copyBtn" type="button">Скопировать</button>
                </div>
                <button class="btn small ghost" id="fullBtn" type="button">Показать полную ссылку</button>
                <div class="hint" id="copyHint">Ссылка готова — отправь её.</div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <span>Сделано с любовью <a href="https://hotsamsawithoneui.t.me">горячей самсой</a></span>
    </footer>

    <script>
        const form = document.getElementById('valentine-form');
        const linkBox = document.getElementById('linkBox');
        const shareLink = document.getElementById('shareLink');
        const copyBtn = document.getElementById('copyBtn');
        const fullBtn = document.getElementById('fullBtn');
        const copyHint = document.getElementById('copyHint');
        const shortenToggle = document.getElementById('shortenToggle');
        const imageUrl = document.getElementById('imageUrl');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        let lastFullUrl = '';
        let lastShortUrl = '';

        const setPreview = (url) => {
            if (!url) {
                imagePreview.hidden = true;
                previewImg.removeAttribute('src');
                return;
            }
            previewImg.src = url;
            imagePreview.hidden = false;
        };

        imageUrl.addEventListener('input', () => {
            setPreview(imageUrl.value.trim());
        });

        const shortenUrl = async (longUrl) => {
            try {
                const body = new URLSearchParams({ url: longUrl });
                const response = await fetch('https://clck.ru/--', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body
                });
                const text = (await response.text()).trim();
                if (response.ok && text.startsWith('http')) {
                    return text;
                }
            } catch (error) {
                return '';
            }

            try {
                const response = await fetch(`https://clck.ru/--?url=${encodeURIComponent(longUrl)}`);
                const text = (await response.text()).trim();
                if (response.ok && text.startsWith('http')) {
                    return text;
                }
            } catch (error) {
                return '';
            }

            return '';
        };

        const setLinkOutput = (url, hint) => {
            shareLink.value = url;
            linkBox.hidden = false;
            copyHint.textContent = hint;

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    copyHint.textContent = 'Ссылка скопирована в буфер обмена.';
                }).catch(() => {
                    copyHint.textContent = 'Не удалось скопировать, сделай это вручную.';
                });
            }
        };

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const toName = document.getElementById('toName').value.trim();
            const wishes = document.getElementById('wishes').value.trim();
            const fromName = document.getElementById('fromName').value.trim();
            const imageLink = imageUrl.value.trim();

            if (!toName || !wishes) {
                return;
            }

            const nextParams = new URLSearchParams();
            nextParams.set('to', toName);
            nextParams.set('wish', wishes);
            if (fromName) {
                nextParams.set('from', fromName);
            }
            if (imageLink) {
                nextParams.set('img', imageLink);
            }

            const baseUrl = new URL(window.location.href);
            baseUrl.pathname = baseUrl.pathname.replace(/[^\/]*$/, '');
            const cardUrl = new URL('valentine.html', baseUrl);
            cardUrl.search = nextParams.toString();
            lastFullUrl = cardUrl.toString();
            lastShortUrl = '';

            if (shortenToggle.checked) {
                setLinkOutput(lastFullUrl, 'Сокращаю ссылку...');
                const shortUrl = await shortenUrl(lastFullUrl);
                if (shortUrl) {
                    lastShortUrl = shortUrl;
                    setLinkOutput(shortUrl, 'Ссылка готова — отправь её.');
                } else {
                    setLinkOutput(lastFullUrl, 'Не удалось сократить. Вот полная ссылка.');
                }
                return;
            }

            setLinkOutput(lastFullUrl, 'Ссылка готова — отправь её.');
        });

        copyBtn.addEventListener('click', () => {
            shareLink.select();
            shareLink.setSelectionRange(0, shareLink.value.length);
            const copied = document.execCommand('copy');
            copyHint.textContent = copied ? 'Ссылка скопирована в буфер обмена.' : 'Не удалось скопировать, сделай это вручную.';
        });

        fullBtn.addEventListener('click', () => {
            if (lastFullUrl) {
                setLinkOutput(lastFullUrl, 'Полная ссылка показана.');
            }
        });
    </script>
</body>
</html>
